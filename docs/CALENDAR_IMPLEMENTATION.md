# Calendar Integration Implementation Plan

## Phase 1: Google Calendar OAuth

### Database Schema Additions

```sql
-- User calendar connections
ALTER TABLE users ADD COLUMN IF NOT EXISTS google_calendar_connected BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS google_access_token TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS google_refresh_token TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS google_token_expiry TIMESTAMPTZ;
ALTER TABLE users ADD COLUMN IF NOT EXISTS google_calendar_id TEXT; -- Their primary calendar ID
ALTER TABLE users ADD COLUMN IF NOT EXISTS calendar_connected_at TIMESTAMPTZ;

-- Organization calendar configuration (generated by Gemini)
CREATE TABLE IF NOT EXISTS org_calendar_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID REFERENCES organizations(id) NOT NULL,
  
  -- Detection rules (JSON from Gemini analysis)
  pto_detection JSONB DEFAULT '{}',
  holiday_detection JSONB DEFAULT '{}',
  partial_day_detection JSONB DEFAULT '{}',
  recurring_schedules JSONB DEFAULT '[]',
  
  -- Identified shared calendars
  shared_calendars JSONB DEFAULT '[]', -- [{name: "Office", calendar_id: "...", type: "pto_source"}]
  holiday_calendars JSONB DEFAULT '[]', -- [{name: "US Holidays", calendar_id: "..."}]
  
  -- Admin input that generated this config
  admin_description TEXT,
  admin_screenshots TEXT[], -- URLs to uploaded screenshots
  
  -- Confidence and status
  confidence_score NUMERIC(3,2),
  needs_clarification BOOLEAN DEFAULT FALSE,
  clarification_questions JSONB DEFAULT '[]',
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  
  UNIQUE(org_id)
);

-- Cache of calendar events (refreshed periodically)
CREATE TABLE IF NOT EXISTS calendar_events_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) NOT NULL,
  calendar_id TEXT NOT NULL,
  event_id TEXT NOT NULL, -- Google's event ID
  
  summary TEXT,
  start_time TIMESTAMPTZ,
  end_time TIMESTAMPTZ,
  is_all_day BOOLEAN DEFAULT FALSE,
  
  -- Detection results (applied from org config)
  detected_as TEXT, -- 'pto', 'partial_pto', 'holiday', 'meeting', 'unknown'
  confidence NUMERIC(3,2),
  
  -- Raw event data for debugging
  raw_event JSONB,
  
  fetched_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, calendar_id, event_id)
);

-- Index for quick lookups
CREATE INDEX IF NOT EXISTS idx_calendar_events_user_time 
ON calendar_events_cache(user_id, start_time, end_time);
```

### Environment Variables Needed

```bash
# Google OAuth (create at console.cloud.google.com)
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3001/auth/google/callback

# Gemini API (Google AI Studio)
GEMINI_API_KEY=your-gemini-api-key
```

### Google Cloud Console Setup

1. Go to console.cloud.google.com
2. Create or select project
3. Enable "Google Calendar API"
4. Create OAuth 2.0 credentials (Web application)
5. Add authorized redirect URIs:
   - `http://localhost:3001/auth/google/callback` (dev)
   - `https://your-domain.com/auth/google/callback` (prod)
6. Copy Client ID and Client Secret

### OAuth Scopes

```
https://www.googleapis.com/auth/calendar.readonly
https://www.googleapis.com/auth/calendar.events.readonly
```

(Read-only is sufficient - we don't create events)

---

## Files to Create

1. `src/lib/google-calendar.ts` — OAuth helpers, token refresh, event fetching
2. `src/lib/gemini.ts` — Gemini API client for config generation
3. `src/api/auth/google.ts` — OAuth routes (initiate, callback)
4. `src/api/calendar/config.ts` — Config management endpoints
5. `src/pages/settings/CalendarSettings.tsx` — UI for connecting calendar
6. `src/pages/admin/CalendarSetup.tsx` — Admin onboarding with Gemini

---

## Implementation Order

1. ✅ Create this plan document
2. [ ] Add database columns/tables (Supabase migration)
3. [ ] Create `google-calendar.ts` with OAuth flow
4. [ ] Create API routes for OAuth
5. [ ] Create settings page for users to connect
6. [ ] Create Gemini integration
7. [ ] Create admin setup flow with screenshot upload
8. [ ] Test end-to-end with Use All Five calendars
